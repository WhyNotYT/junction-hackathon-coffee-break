<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéµ Data Symphony Composer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Courier New", monospace;
        color: white;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .control-group {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }

      input,
      button,
      select {
        padding: 10px;
        border: none;
        border-radius: 5px;
        font-family: inherit;
      }

      input {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        width: 150px;
      }

      button {
        background: #ff6b6b;
        color: white;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      button:hover {
        background: #ff5252;
        transform: translateY(-2px);
      }

      button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
      }

      .symphony-stage {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .instrument {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .instrument.playing {
        border-color: #00ff88;
        box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        animation: pulse 0.5s ease-in-out;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      .instrument-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .instrument-name {
        font-size: 1.3em;
        font-weight: bold;
      }

      .instrument-info {
        font-size: 0.9em;
        opacity: 0.8;
        text-align: right;
      }

      .connection-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 255, 136, 0.2);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        border: 1px solid #00ff88;
      }

      .data-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .column-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85em;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
      }

      .column-item.playing {
        background: rgba(255, 107, 107, 0.3);
        animation: flash 0.3s ease-in-out;
      }

      .column-item.null-data {
        opacity: 0.5;
        background: rgba(100, 100, 100, 0.2);
      }

      .column-item.null-data .column-value {
        color: #888;
        font-style: italic;
      }

      @keyframes flash {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .column-name {
        font-weight: bold;
        color: #00ff88;
      }

      .column-value {
        color: #fff;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .status {
        text-align: center;
        margin: 20px 0;
        font-size: 1.1em;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
        transition: width 0.3s ease;
        border-radius: 10px;
      }

      .error {
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid #ff6b6b;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
      }

      .loading {
        text-align: center;
        opacity: 0.7;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéµ Data Symphony Composer</h1>
        <p>Turn your data lineage into beautiful music!</p>
      </div>

      <div class="controls">
        <div class="control-group">
          <input type="text" id="personId" placeholder="Enter Person ID" />
          <button id="playBtn" onclick="composeSymphony()">
            üéº Compose & Play
          </button>
        </div>

        <div class="control-group">
          <button id="stopBtn" onclick="stopSymphony()" disabled>
            ‚èπÔ∏è Stop
          </button>
          <select id="tempoControl">
            <option value="1">Normal Speed</option>
            <option value="0.5">Slow Motion</option>
            <option value="2">2x Speed</option>
          </select>
        </div>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
      </div>

      <div id="status" class="status">
        Enter a person ID to compose their data symphony! üé∂
      </div>

      <div id="symphonyStage" class="symphony-stage"></div>
    </div>

    <script>
      let currentSymphony = null;
      let isPlaying = false;
      let synths = {};
      let playbackTimeout;

      async function composeSymphony() {
        const personId = document.getElementById("personId").value;
        if (!personId) {
          alert("Please enter a Person ID");
          return;
        }

        await Tone.start();

        document.getElementById("status").innerHTML =
          '<div class="loading"><div class="spinner"></div>Loading symphony data...</div>';
        document.getElementById("playBtn").disabled = true;

        try {
          const response = await fetch(`/api/symphony/${personId}`);
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          currentSymphony = data;
          setupInstruments();
          playSymphony();
        } catch (error) {
          document.getElementById(
            "status"
          ).innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
          document.getElementById("playBtn").disabled = false;
        }
      }

      function setupInstruments() {
        const stage = document.getElementById("symphonyStage");
        stage.innerHTML = "";

        // Dispose old synths
        Object.values(synths).forEach((synth) => synth.dispose());
        synths = {};

        currentSymphony.instruments.forEach((instrument, i) => {
          // Create synth for each instrument
          const synthType = getSynthType(instrument.instrument);
          synths[instrument.table_name] = new Tone.Synth(
            synthType
          ).toDestination();
          synths[instrument.table_name].volume.value =
            -20 + instrument.volume * 15;

          // Create visual element
          const instrumentEl = document.createElement("div");
          instrumentEl.className = "instrument";
          instrumentEl.id = `instrument-${i}`;
          instrumentEl.style.position = "relative";

          instrumentEl.innerHTML = `
                    <div class="connection-indicator">
                        üîó ${instrument.matched_column}
                    </div>
                    <div class="instrument-header">
                        <div>
                            <div class="instrument-name">üéπ ${
                              instrument.table_name
                            }</div>
                            <div class="instrument-info">
                                Instrument: ${instrument.instrument}<br>
                                Data Density: ${instrument.data_density}/${
            instrument.total_columns
          } fields
                            </div>
                        </div>
                        <div class="instrument-info">
                            Tempo: ${instrument.tempo} BPM<br>
                            Volume: ${Math.round(instrument.volume * 100)}%<br>
                            Notes: ${instrument.melody.length}
                        </div>
                    </div>
                    <div class="data-columns" id="columns-${i}">
                        ${instrument.column_data
                          .map(
                            (col, j) =>
                              `<div class="column-item ${
                                col.has_data ? "" : "null-data"
                              }" id="col-${i}-${j}">
                                <span class="column-name">${col.column}</span>
                                <span class="column-value">${col.value}</span>
                            </div>`
                          )
                          .join("")}
                    </div>
                `;

          stage.appendChild(instrumentEl);
        });

        document.getElementById(
          "status"
        ).textContent = `üéº Symphony composed! ${currentSymphony.instruments.length} tables will play together showing data relationships.`;
      }

      function getSynthType(instrumentName) {
        const synthTypes = {
          piano: {
            oscillator: { type: "triangle" },
            envelope: { attack: 0.1, decay: 0.3, sustain: 0.2, release: 0.8 },
          },
          synth: {
            oscillator: { type: "sawtooth" },
            envelope: { attack: 0.02, decay: 0.1, sustain: 0.9, release: 0.3 },
          },
          bass: {
            oscillator: { type: "square" },
            envelope: { attack: 0.1, decay: 0.2, sustain: 0.8, release: 0.5 },
          },
          lead: {
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.2 },
          },
          pad: {
            oscillator: { type: "triangle" },
            envelope: { attack: 0.5, decay: 0.2, sustain: 0.8, release: 1.0 },
          },
          pluck: {
            oscillator: { type: "square" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.3 },
          },
          bell: {
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.5, sustain: 0.0, release: 1.0 },
          },
          drum: {
            oscillator: { type: "noise" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.1 },
          },
        };
        return synthTypes[instrumentName] || synthTypes["synth"];
      }

      async function playSymphony() {
        if (!currentSymphony) return;

        isPlaying = true;
        document.getElementById("playBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;

        const tempoMultiplier = parseFloat(
          document.getElementById("tempoControl").value
        );
        const totalDuration =
          (currentSymphony.composition_length * 1000) / tempoMultiplier;
        let startTime = Date.now();

        // Play all instruments simultaneously with different start times
        currentSymphony.instruments.forEach((instrument, instIndex) => {
          const synth = synths[instrument.table_name];
          const instrumentStartDelay = (instIndex * 2000) / tempoMultiplier; // Stagger instrument entries

          // Highlight instrument when it starts
          setTimeout(() => {
            if (!isPlaying) return;
            highlightInstrument(instIndex);
            document.getElementById("status").textContent = `üéµ Playing: ${
              instrument.table_name
            } (${instIndex + 1}/${currentSymphony.instruments.length})`;
          }, instrumentStartDelay);

          // Schedule notes for this instrument
          instrument.melody.forEach((note, noteIndex) => {
            const noteDelay =
              instrumentStartDelay + (note.start_time * 1000) / tempoMultiplier;
            const duration = (note.duration * 1000) / tempoMultiplier;

            setTimeout(() => {
              if (!isPlaying) return;

              // Play note
              synth.triggerAttackRelease(note.frequency, duration / 1000);

              // Visual feedback
              highlightColumn(instIndex, noteIndex, duration);
            }, noteDelay);
          });
        });

        // Progress bar animation
        let progressInterval = setInterval(() => {
          if (!isPlaying) {
            clearInterval(progressInterval);
            return;
          }

          const elapsed = Date.now() - startTime;
          const progress = Math.min((elapsed / totalDuration) * 100, 100);
          document.getElementById("progressBar").style.width = progress + "%";

          if (progress >= 100) {
            clearInterval(progressInterval);
            stopSymphony();
          }
        }, 100);

        // Final status update
        setTimeout(() => {
          if (isPlaying) {
            document.getElementById("status").textContent =
              "üéµ All instruments playing together in harmony!";
          }
        }, (currentSymphony.instruments.length * 2000) / tempoMultiplier);
      }

      function highlightInstrument(instIndex) {
        const instrument = document.getElementById(`instrument-${instIndex}`);
        if (instrument) {
          instrument.classList.add("playing");
          setTimeout(() => instrument.classList.remove("playing"), 500);
        }
      }

      function highlightColumn(instIndex, columnIndex, duration) {
        const column = document.getElementById(
          `col-${instIndex}-${columnIndex}`
        );
        if (column) {
          column.classList.add("playing");
          setTimeout(() => column.classList.remove("playing"), duration);
        }
      }

      function stopSymphony() {
        isPlaying = false;

        // Stop all synths
        Object.values(synths).forEach((synth) => {
          synth.triggerRelease();
        });

        // Reset UI
        document.getElementById("playBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("status").textContent = "‚èπÔ∏è Symphony stopped.";

        // Remove playing classes
        document.querySelectorAll(".playing").forEach((el) => {
          el.classList.remove("playing");
        });
      }

      // Allow Enter key to trigger composition
      document
        .getElementById("personId")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            composeSymphony();
          }
        });

      // Demo mode - show sample data
      window.addEventListener("load", () => {
        document.getElementById("personId").value = "100001";
        document.getElementById("status").innerHTML =
          'üéº Ready to compose! Try person ID "100001" or enter your own.';
      });
    </script>
  </body>
</html>
